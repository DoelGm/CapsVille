<section class="mt-4 pt-5">
  <div class="container">
    <div class="row">
      <div class="col-md-12 col-12 p-4 bg-light rounded shadow">
        <h1>Lista de Productos</h1>
        
        <!-- Alertas -->
        <div *ngIf="successMessage" class="alert alert-success alert-dismissible fade show" role="alert">
          {{ successMessage }}
          <button type="button" class="btn-close" (click)="dismissAlert('success')" aria-label="Close"></button>
        </div>
        <div *ngIf="errorMessage" class="alert alert-danger alert-dismissible fade show" role="alert">
          {{ errorMessage }}
          <button type="button" class="btn-close" (click)="dismissAlert('error')" aria-label="Close"></button>
        </div>

        <!-- Vista de tabla -->
        <div *ngIf="!isEditing" class="table-responsive rounded mb-3">
           <table class="table table-hover align-middle mb-0 bg-white rounded table-sm">
            <thead class="table-secondary text-center text-secondary">
              <tr>
                <th>#</th>
                <th>Nombre</th>
                <th>Descripción</th>
                <th>Precio</th>
                <th>Stock</th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody class="text-center">
              <tr *ngFor="let product of products | paginate: { itemsPerPage: itemsPerPage, currentPage: p }">
                <td><strong>{{ product.id }}</strong></td>
                <td>{{ product.name }}</td>
                <td class="text-truncate" style="max-width: 200px;">{{ product.description }}</td>
                <td>
                  <span class="badge bg-success">{{ product.price | currency }}</span>
                  <span *ngIf="product.discount > product.price" class="text-danger ms-2">
                    {{ calculateDiscount(product.price, product.discount) }}% OFF
                  </span>
                </td>
                <td>
                  <span [class]="product.stock > 0 ? 'text-success' : 'text-danger'">
                    {{ product.stock }}
                  </span>
                </td>
                <td>
                  <div class="d-flex justify-content-center gap-2">
                    <button class="btn btn-outline-primary btn-sm" (click)="prepareEdit(product)">
                      <i class="fas fa-edit me-1"></i> Editar
                    </button>
                    <button class="btn btn-outline-danger btn-sm" (click)="prepareDelete(product)">
                      <i class="fas fa-trash-alt me-1"></i> Eliminar
                    </button>
                  </div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>

        <!-- Formulario de edición -->
        <div *ngIf="isEditing" class="mt-4 p-4 bg-light rounded">
          <h2>Editar Producto: {{productToEdit.name}}</h2>
          
          <form #editForm="ngForm" (ngSubmit)="updateProduct()">
            <div class="mb-3">
              <label class="form-label">Nombre</label>
              <input type="text" class="form-control" [(ngModel)]="productToEdit.name" name="name" required>
            </div>
            
            <div class="mb-3">
              <label class="form-label">Descripción</label>
              <textarea class="form-control" rows="3" [(ngModel)]="productToEdit.description" name="description" required></textarea>
            </div>
            
            <div class="mb-3">
              <label class="form-label">Imagen (URL)</label>
              <input type="url" class="form-control" [(ngModel)]="productToEdit.imageUrl" name="imageUrl">
              <img *ngIf="productToEdit.imageUrl" [src]="productToEdit.imageUrl" class="img-thumbnail mt-2" style="max-height: 100px;">
            </div>

            <div class="row mb-3">
              <div class="col-md-3 col-3 mb-3 mb-md-0">
                <label class="form-label">Precio</label>
                <div class="input-group">
                  <span class="input-group-text">$</span>
                  <input type="number" step="0.01" class="form-control" [(ngModel)]="productToEdit.price" name="price" required>
                </div>
              </div>

              <div class="col-md-3 col-3 mb-3 mb-md-0">
                <label class="form-label">Precio de Comparación</label>
                <div class="input-group">
                  <span class="input-group-text">$</span>
                  <input type="number" step="0.01" class="form-control" [(ngModel)]="productToEdit.discount" name="discount">
                </div>
                <div *ngIf="productToEdit.discount > productToEdit.price" class="text-danger small mt-1">
                  {{ calculateDiscount(productToEdit.price, productToEdit.discount) }}% de descuento
                </div>
              </div>

              <div class="col-md-3 col-3 mb-3 mb-md-0">
                <label class="form-label">Stock</label>
                <input type="number" class="form-control" [(ngModel)]="productToEdit.stock" name="stock" required>
              </div>

              <div class="col-md-3 col-3 mb-3 mb-md-0">
                <label class="form-label">Categoría</label>
                <select class="form-select" [(ngModel)]="productToEdit.category_id" name="category" required>
                  <option value="" disabled>Seleccione categoría</option>
                  <option *ngFor="let category of categories" [value]="category.id">
                    {{ category.name }}
                  </option>
                </select>
              </div>
            </div>
            
            <div class="d-flex gap-2">
              <button type="submit" class="btn btn-primary" [disabled]="editForm.invalid">
                <i class="fas fa-save me-1"></i> Guardar Cambios
              </button>
              <button type="button" class="btn btn-secondary" (click)="cancelEdit()">
                <i class="fas fa-times me-1"></i> Cancelar
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</section>

<!-- Modal de confirmación -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title" id="deleteModalLabel">Confirmar eliminación</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        ¿Estás seguro de que deseas eliminar el producto "{{ productToDelete?.name }}"? Esta acción no se puede deshacer.
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button type="button" class="btn btn-danger" (click)="confirmDelete()" data-bs-dismiss="modal">
          <i class="fas fa-trash-alt me-1"></i> Eliminar
        </button>
      </div>
    </div>
  </div>
</div>